# 인터럽트 3

## 코드
```java
public class ThreadStopMainV3 {
    public static void main(String[] args) {
        MyTask task = new MyTask();
        Thread thread = new Thread(task, "work");
        thread.start();

        sleep(100); // 시간을 줄임
        log("작업 중단 지시 - thread.interrupt()");

        thread.interrupt();
        log("work 스레드 인터럽트 상태1 = " + thread.isInterrupted());
    }
    static class MyTask implements Runnable {
        @Override
        public void run() {
            while (!Thread.currentThread().isInterrupted()) { // 인터럽트 상태 변경X
                log("작업 중");
            }
            log("work 스레드 인터럽트 상태2 = " + Thread.currentThread().isInterrupted());

            try {
                log("자원 정리 시도");
                Thread.sleep(1000);
                log("자원 정리 완료");
            } catch (InterruptedException e) {
                log("자원 정리 실패 - 자원 정리 중 인터럽트 발생");
                log("work 스레드 인터럽트 상태3 = " +
                Thread.currentThread().isInterrupted());
            }

            log("작업 종료");
        }
    }
}
```

## 🧵인터럽트 상태 직접 확인 + 자원 정리 실패 흐름
```mermaid
sequenceDiagram
    participant MainThread
    participant WorkThread

    Note over MainThread: 프로그램 시작
    MainThread->>WorkThread: Thread.start() 호출
    WorkThread->>WorkThread: while (!isInterrupted()) 반복 시작

    loop 작업 루프
        WorkThread->>WorkThread: log("작업 중")
    end

    Note over MainThread: sleep(100ms) 후 인터럽트 지시
    MainThread->>WorkThread: thread.interrupt() 호출
    MainThread->>MainThread: log("인터럽트 상태1 = true")

    WorkThread->>WorkThread: 인터럽트 상태 확인<br>→ while 탈출
    WorkThread->>WorkThread: log("인터럽트 상태2 = true")

    Note over WorkThread: 자원 정리 시도
    WorkThread->>WorkThread: Thread.sleep(1000) 호출
    WorkThread->>WorkThread: InterruptedException 발생<br>→ catch 진입
    WorkThread->>WorkThread: log("자원 정리 실패")<br>log("인터럽트 상태3 = false")
    WorkThread->>WorkThread: log("작업 종료")
```


## 🔍 핵심 흐름 요약
- work 스레드는 isInterrupted()로 인터럽트 상태를 직접 확인하고 반복문 탈출
- 하지만 인터럽트 상태가 true로 유지된 채 자원 정리 코드(sleep())를 실행
- 그 결과 InterruptedException이 발생하여 자원 정리에 실패
- 예외 발생 후 인터럽트 상태는 자동으로 false로 초기화됨


## ✅ 교훈 및 개선 포인트

| 항목                     | 설명                                                                 | 관련 위치 또는 메서드             |
|--------------------------|----------------------------------------------------------------------|-----------------------------------|
| isInterrupted()          | 현재 스레드의 인터럽트 상태를 확인하지만 상태를 초기화하지 않음       | while 조건문, 반복문 탈출용       |
| sleep()                  | 인터럽트 상태일 경우 예외 발생 → 자원 정리 중 예외로 실패 가능         | 자원 정리 단계에서 Thread.sleep() |
| Thread.interrupted()     | 인터럽트 상태를 확인하고 동시에 상태를 초기화함                        | 자원 정리 전에 호출해 상태 복구   |
| InterruptedException     | 예외 발생 시 인터럽트 상태가 자동으로 false로 초기화됨                 | catch 블록                        |


## 🔍 핵심 요약
- isInterrupted()는 상태를 확인만 하므로, 이후 sleep() 같은 코드에서 예외가 발생할 수 있음
- 자원 정리 전에 Thread.interrupted()를 호출하면 상태를 초기화해서 예외를 방지할 수 있음
- InterruptedException이 발생하면 상태는 자동으로 false로 돌아오므로 catch 블록에서 안전하게 처리 가능

## 🧩 자원 정리 실패의 정확한 원인
### 🔥 상황 요약
- work 스레드는 interrupt()를 받아서 인터럽트 상태가 true가 됨
- while (!isInterrupted()) 조건으로 반복문을 탈출함 → 여기까지는 OK
- 이후 자원 정리를 위해 Thread.sleep(1000)을 호출함
- 그런데 스레드의 인터럽트 상태가 여전히 true였기 때문에
- sleep()은 즉시 InterruptedException을 던짐
- 결과적으로 자원 정리 코드가 예외로 중단됨

### 🧪 왜 이런 일이 생겼는가?

| 항목                  | 설명                                                                 | 결과 또는 영향                         |
|-----------------------|----------------------------------------------------------------------|----------------------------------------|
| isInterrupted()       | 인터럽트 상태를 확인만 하고 초기화하지 않음                          | 반복문은 탈출하지만 상태는 true 유지     |
| sleep()               | 인터럽트 상태가 true일 경우 즉시 InterruptedException 발생           | 자원 정리 중 예외 발생 → 실패           |
| InterruptedException  | 예외 발생 시 인터럽트 상태가 자동으로 false로 초기화됨               | 이후 코드에서 인터럽트 영향 없음        |
| 상태 초기화 누락      | 반복문 탈출 후 인터럽트 상태를 수동으로 초기화하지 않음              | 자원 정리 코드에서 예외 발생             |
| 예외 처리 위치        | 자원 정리 코드가 try-catch로 감싸져 있지 않거나 예외를 예상하지 않음 | 자원 정리 실패 가능성 증가              |

---





