# ë™ê¸°í™” ë¬¸ì œ
## ğŸ§  í•µì‹¬ ìš”ì•½: ë™ê¸°í™” ë¬¸ì œì˜ ì›ì¸
## ì†ŒìŠ¤ ì½”ë“œ
```java
public interface BankAccount {
    boolean withdraw(int amount);
    int getBalance();
    }
```
```java
public class BankAccountV1 implements BankAccount {
    private int balance;
    //volatile private int balance;
    public BankAccountV1(int initialBalance) {
        this.balance = initialBalance;
    }

    @Override
    public boolean withdraw(int amount) {

        log("ê±°ë˜ ì‹œì‘: " + getClass().getSimpleName());
        log("[ê²€ì¦ ì‹œì‘] ì¶œê¸ˆì•¡: " + amount + ", ì”ì•¡: " + balance);
        if (balance < amount) {
            log("[ê²€ì¦ ì‹¤íŒ¨] ì¶œê¸ˆì•¡: " + amount + ", ì”ì•¡: " + balance);
            return false;
        }

        log("[ê²€ì¦ ì™„ë£Œ] ì¶œê¸ˆì•¡: " + amount + ", ì”ì•¡: " + balance);
        sleep(1000); // ì¶œê¸ˆì— ê±¸ë¦¬ëŠ” ì‹œê°„ìœ¼ë¡œ ê°€ì •

        balance = balance - amount;

        log("[ì¶œê¸ˆ ì™„ë£Œ] ì¶œê¸ˆì•¡: " + amount + ", ë³€ê²½ ì”ì•¡: " + balance);
        log("ê±°ë˜ ì¢…ë£Œ");

        return true;
    }

    @Override
    public int getBalance() {
        return balance;
    }
}
```
```java
public class WithdrawTask implements Runnable {
    private BankAccount account;
    private int amount;

    public WithdrawTask(BankAccount account, int amount) {
        this.account = account;
        this.amount = amount;
    }

    @Override
    public void run() {
        account.withdraw(amount);
    }
}
```
```java
public class BankMain {
    public static void main(String[] args) throws InterruptedException {
        BankAccount account = new BankAccountV1(1000);
        Thread t1 = new Thread(new WithdrawTask(account, 800), "t1");
        Thread t2 = new Thread(new WithdrawTask(account, 800), "t2");
        t1.start();
        t2.start();

        sleep(500); // ê²€ì¦ ì™„ë£Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°

        log("t1 state: " + t1.getState());
        log("t2 state: " + t2.getState());
        t1.join();
        t2.join();
        log("ìµœì¢… ì”ì•¡: " + account.getBalance());
    }
}
```
## ğŸ” ë¬¸ì œ ìƒí™©
- ë‘ ê°œì˜ ìŠ¤ë ˆë“œ t1, t2ê°€ ë™ì‹œì— ê°™ì€ BankAccountV1 ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•´ withdraw(800)ì„ í˜¸ì¶œ
- balance = 1000ì¸ ìƒíƒœì—ì„œ ë‘ ìŠ¤ë ˆë“œê°€ ê±°ì˜ ë™ì‹œì— ê²€ì¦ì„ í†µê³¼í•¨
- ì¶œê¸ˆì´ ì™„ë£Œë˜ë©´ balance = -600ì´ ë˜ëŠ” ë¹„ì •ìƒì ì¸ ê²°ê³¼ ë°œìƒ

### ğŸ”“ ë¬¸ì œ ì›ì¸
- withdraw() ë©”ì„œë“œê°€ ë™ê¸°í™”ë˜ì§€ ì•ŠìŒ
- balance í•„ë“œëŠ” ê³µìœ  ìì›ì´ë©°, ë™ì‹œì— ì ‘ê·¼í•˜ë©´ Race Condition ë°œìƒ
- volatile í‚¤ì›Œë“œë¡œëŠ” í•´ê²°ë˜ì§€ ì•ŠìŒ â†’ ì´ëŠ” ë©”ëª¨ë¦¬ ê°€ì‹œì„±ë§Œ ë³´ì¥í•˜ê³  ì›ìì„±ì€ ë³´ì¥í•˜ì§€ ì•ŠìŒ

ğŸ§© ë‹¤ì´ì–´ê·¸ë¨: ë©”ëª¨ë¦¬ êµ¬ì¡° ì‹œê°í™”
```mermaid
classDiagram
class BankAccount {
  <<interface>>
  +withdraw(int): boolean
  +getBalance(): int
}

class BankAccountV1 {
  -balance: int = 1000
  +withdraw(int): boolean
  +getBalance(): int
}

class WithdrawTask {
  -account: BankAccount
  -amount: int
  +run(): void
}

class Thread_t1 {
  +run(): void
}

class Thread_t2 {
  +run(): void
}

BankAccount <|-- BankAccountV1
WithdrawTask --> BankAccountV1 : account
Thread_t1 --> WithdrawTask : x002
Thread_t2 --> WithdrawTask : x003
WithdrawTask --> BankAccountV1 : withdraw()
```


## ğŸ’¥ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
```
[t1] ê±°ë˜ ì‹œì‘ â†’ ê²€ì¦ ì™„ë£Œ â†’ ì¶œê¸ˆ ì™„ë£Œ â†’ ì”ì•¡: 200
[t2] ê±°ë˜ ì‹œì‘ â†’ ê²€ì¦ ì™„ë£Œ â†’ ì¶œê¸ˆ ì™„ë£Œ â†’ ì”ì•¡: -600
[main] ìµœì¢… ì”ì•¡: -600
```

## âš ï¸ ê¸°ëŒ€ ê²°ê³¼ì™€ ë‹¤ë¥¸ ì´ìœ 
- t1ê³¼ t2ê°€ **ê²€ì¦ ë‹¨ê³„ì—ì„œ ë™ì¼í•œ ì”ì•¡(1000)** ì„ ë³´ê³  ì¶œê¸ˆì„ ì§„í–‰
- sleep(1000)ìœ¼ë¡œ ì¸í•´ ì¶œê¸ˆì´ ì§€ì—°ë˜ë©´ì„œ ë‘ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì¶œê¸ˆì„ ì™„ë£Œ
- ë™ê¸°í™”ê°€ ì—†ê¸° ë•Œë¬¸ì— ì”ì•¡ì´ ìŒìˆ˜ê°€ ë˜ëŠ” ë¹„ì •ìƒì ì¸ ê²°ê³¼ ë°œìƒ

---

